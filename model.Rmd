---
title: "Regression model"

output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

```{r setup, include = FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(caret)
```



# Data Set Splitting

We firstly divide the data set into training and testing sets.
```{r}
data=readRDS("data_for_model.rds") 
training_data <- filter(data, year >= 2018 & year <= 2020)|>select(-c(state,year))
testing_data <- filter(data, year == 2021)|>select(-c(state,year))
```

# Multiple Linear Regression

## Model Selection

Explain why multiple linear regression was chosen.
Describe the mathematical form of the model and assumptions.

## Full model-Linear regression 

```{r}
model <- lm(death_rate ~ employment+hc_exp+income+edu_level+cardio_rate+smoke_rate+elder_rate, data = training_data)
summary(model)
```

## Backwards Elimination

```{r}
backward_result=step(model, direction='backward')
```


## Selected value

```{r}
selected_model <- lm(death_rate ~ hc_exp + edu_level + cardio_rate + elder_rate, data = training_data)
summary(selected_model)
```
## Model Performation

```{r}
predictions <- predict(selected_model, testing_data)

mse <- mean((testing_data$death_rate - predictions)^2)
print(paste("MSE:", mse))

# R²
r_squared <- cor(testing_data$death_rate, predictions)^2
print(paste("R²:", r_squared))
```




表现太差了-解释一下


# Random Forest Model

## Model Selection

Justify the choice of the random forest model.
Explain the fundamental principles of the model.

```{r}
library(randomForest)

rf_model <- randomForest(death_rate ~employment+hc_exp+income+edu_level+cardio_rate+smoke_rate+elder_rate, data = training_data)
```

## Model Performation

```{r}
rf_predictions <- predict(rf_model, testing_data)

rf_mse <- mean((testing_data$death_rate - rf_predictions)^2)
print(paste("Random Forest MSE:", rf_mse))

rf_predictions <- predict(rf_model, training_data)

# R²
r_squared <- cor(training_data$death_rate, rf_predictions)^2
print(paste("R²:", r_squared))


rf_predictions <- predict(rf_model, testing_data)

# R²
r_squared <- cor(testing_data$death_rate, rf_predictions)^2
print(paste("R²:", r_squared))
```

```{r}
# Assuming you have actual_values, predicted_values_lm, and predicted_values_rf

# Create a scatter plot
plot(testing_data$death_rate, predictions, main = "Linear Regression Predictions", xlab = "Actual Values", ylab = "Predicted Values", col = "black")





```



## Results and Discussion

```{r}
importance_values <- importance(rf_model)


print(importance_values)

library(plotly)

importance_values <- importance(rf_model)

feature_importance <- data.frame(Feature = rownames(importance_values), 
                                 Importance = importance_values[,1]) %>%
  arrange(Importance) %>% 
  mutate(Feature = factor(Feature, levels = Feature)) 

plot_ly(feature_importance, x = ~Importance, y = ~Feature, type = 'bar', orientation = 'h') %>%
  layout(title = "Feature Importance from Random Forest Model",
         xaxis = list(title = "Importance"),
         yaxis = list(title = "Feature"))
```


数值较高的特征被视为更重要，diabetes_rate，rpp，obesity_rate 最重要 - 待解释

Summarize the performance of multiple linear regression and random forest models.

Interpret model results and important features.
Discuss limitations of the study and future work.







